<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<script>"use strict";Polymer.BnmHttpCodesBehavior={properties:{promise:{type:Object}},observers:["_promiseChange(promise)"],_showFormatError:function(r,e,o){switch(e){case 400:this.errorCode400(r,o);break;case 401:this.errorCode401(r,o);break;case 404:this.errorCode404(r,o);break;case 412:this.errorCode412(r);break;case 413:this.errorCode413(r);break;case 402:case 403:case 405:case 408:this.errorRequestError(r);break;case 406:this.errorCode406(r);break;case 499:this.errorRequestUnknown(r);break;case 502:this.errorCode502(r,o);break;case 500:case 501:case 503:case 504:case 505:this.errorServerError(r)}},_promiseChange:function(r){var e=this;r.then(function(){})["catch"](function(r){if("object"===("undefined"==typeof r?"undefined":$traceurRuntime["typeof"](r))){var o;o=r.message.error?r.message.error.message:r.message.message,e._showFormatError(e.closest("widget-card"),r.code,o)}"string"==typeof r&&console.error(r)})},errorCode400:function(r,e){console.warn(e);var o="Некорректно указано значение поля";if(r){var s=r.querySelectorAll("input-format");if(s&&1===s.length)s[0].errorMessage=o;else switch("undefined"==typeof e?"undefined":$traceurRuntime["typeof"](e)){case"string":NOTIFICATION.showFormError(r,o);break;default:NOTIFICATION.showFormError(r,o)}}},errorCode401:function(r,e){console.warn("code 401"),e=e||"Запрос вернул ошибку 401",NOTIFICATION.showFormError(r,e),app.onLogout()},errorCode404:function(r,e){console.warn("404: not found"),e=e||"Запрос вернул ошибку 404",NOTIFICATION.showFormError(r,e)},errorCode406:function(r){var e="Недопустимое действие";NOTIFICATION.showFormError(r,e)},errorCode502:function(r,e){console.warn("502: server error"),e=e||"Сервер недоступен",NOTIFICATION.showFormError(r,e)},errorRequestError:function(r){NOTIFICATION.showFormError(r,"Ошибка обработки запроса")},errorRequestUnknown:function(r){NOTIFICATION.showFormError(r,"Запрос прервался")},errorCode412:function(r){NOTIFICATION.showFormError(r,"Ошибка загрузки данных")},errorCode413:function(r){NOTIFICATION.showFormError(r,"Превышение допустимого размера файла")},errorServerError:function(r){NOTIFICATION.showFormError(r,"Сервер недоступен")}};</script>
<script>"use strict";!function(){function e(e){var t=this,r=new Promise(function(r,n){var a=new XMLHttpRequest;a.open(o,s+"/"+e),a.setRequestHeader("X-Auth-Token",t.token),a.send(null),a.onreadystatechange=function(e){return a.DONE===e.target.readyState?(SERVER.validSession(e.target),t.parseResponse(e,r,n)):void 0},a.onerror=t.xhrOnerror});return this.promise=r,this.isAuth.then(function(){return r})["catch"](function(e){return t.rejectError(e)})}function t(e,t){var r=this,n=new Promise(function(n,o){var i=new XMLHttpRequest;i.open(a,s+"/"+e),i.setRequestHeader("X-Auth-Token",r.token),i.send(JSON.stringify({data:t})),i.responseType="text",i.onreadystatechange=function(e){return i.DONE===e.target.readyState?r.parseResponse(e,n,o):void 0},i.onerror=r.xhrOnerror});return this.promise=n,this.isAuth.then(function(){return n})["catch"](function(e){return r.rejectError(e)})}function r(e,t){var r=this,n=new Promise(function(n,o){if(!app.isLogin)return o({code:401,message:"not login"});var a=new XMLHttpRequest;a.open(u,s+"/"+e),a.setRequestHeader("X-Auth-Token",r.token),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify({data:t})),a.onreadystatechange=function(e){return a.DONE===e.target.readyState?r.parseResponse(e,n,o):void 0},a.onerror=r.xhrOnerror});return this.promise=n,this.isAuth.then(function(){return n})["catch"](function(e){return r.rejectError(e)})}function n(e,t){var r=this,n=new Promise(function(n,o){var a=new XMLHttpRequest;a.open(i,s+"/"+e),a.setRequestHeader("X-Auth-Token",r.token),a.send(JSON.stringify({data:t})),a.onreadystatechange=function(e){return a.DONE===e.target.readyState?r.parseResponse(e,n,o):void 0},a.onerror=r.xhrOnerror});return this.promise=n,this.isAuth.then(function(){return n})["catch"](function(e){return r.rejectError(e)})}var s=CONFIG.urlAPI,o="GET",a="POST",i="PUT",u="DELETE";new Polymer({is:"bnm-http",hostAttributes:{hidden:!0},behaviors:[Polymer.BnmHttpCodesBehavior],getBlobURL:function(e){var t=this,r=new Promise(function(r,n){var a=new XMLHttpRequest;a.open(o,s+"/"+e),a.setRequestHeader("X-Auth-Token",t.token),a.responseType="blob",a.send(null),a.onreadystatechange=function(e){if(a.DONE===e.target.readyState){if(e.target.status<200||e.target.status>=300)return n({error:e.target.status,message:"status error"});var t=new Blob([e.target.response],{type:"application/octet-binary"});return r(URL.createObjectURL(t))}},a.onerror=t.xhrOnerror});return this.promise=r,this.isAuth.then(function(){return r})["catch"](function(e){return t.rejectError(e)})},getFile:function(e){var t=this,r=new Promise(function(r,n){var a=new XMLHttpRequest;a.open(o,s+"/"+e),a.setRequestHeader("X-Auth-Token",t.token),a.responseType="blob",a.send(null),a.onreadystatechange=function(e){if(a.DONE===e.target.readyState){if(e.target.status<200||e.target.status>=300)return n({error:e.target.status,message:"status error"});var t=new Blob([e.target.response],{type:"application/octet-binary"}),s=new FileReader;s.addEventListener("loadend",function(e){return r(e.target.result)}),s.readAsDataURL(t)}},a.onerror=t.xhrOnerror});return this.promise=r,this.isAuth.then(function(){return r})["catch"](function(e){return t.rejectError(e)})},get:e,post:t,"delete":r,put:n,onerror:function(e){if(this.status){var t="xhr error "+this.status;NOTIFICATION.show(t)}console.error(e)},get token(){var e=sessionStorage.getItem("token");return e},get isAuth(){var e=this;return new Promise(function(t,r){var n=e.token;return app.isLogin?validator.isNull(n)?void r({code:401,message:"token is empty"}):t("ok"):r({code:401,message:"not login"})})},checkStatus:function(e){return 200>e||e>=300},xhrOnerror:function(e){return Promise.reject({code:e.target.status,message:"httpRequest error"})},parseResponse:function(e,t,r){if(this.checkStatus(e.target.status))return r({code:e.target.status,message:{code:e.target.status,message:"Сервер недоступен"}});if(!e.target.responseText)return r({code:e.target.status,message:{code:e.target.status,message:"responseText is empty"}});if(validator.isJSON(e.target.responseText)){var n=JSON.parse(e.target.responseText);return n.error?r({code:n.code,message:n}):t(LOCALIZATION.localizationResponce(n))}if(validator.isAscii(e.target.responseText)){var s=e.target.responseText.toString();return t(s)}return r({code:e.target.status,message:"invalid arguments"})},rejectError:function(e){return 401===e.code&&this.async(function(){app.$.authorization.show()},1),Promise.reject({code:e.code,message:e.message})}})}();</script>
